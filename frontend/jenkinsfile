pipeline {
  agent any

  environment {
    DOCKER_IMAGE          = 'tanpiyangkoon/it-request-frontend'
    DOCKER_CREDENTIALS_ID = 'dockerhub-credentials'
    GITOPS_REPO           = 'https://github.com/tanPiyangkoon/it-request-frontend-kustomize.git'
    GITOPS_BRANCH         = 'staging'
    GITOPS_CREDENTIALS_ID = 'github-token'
    ARGOCD_APP            = 'it-request-frontend-service'
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: 'main', url: 'https://github.com/tanPiyangkoon/it-request-frontend.git'
      }
    }

    stage('Build & Push Docker Image') {
      steps {
        script {
          def shortCommit = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
          env.IMG_TAG = shortCommit

          withCredentials([usernamePassword(credentialsId: "${DOCKER_CREDENTIALS_ID}",
                                            usernameVariable: 'DOCKER_USER',
                                            passwordVariable: 'DOCKER_PASS')]) {
            sh '''
              echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
              docker build -t ${DOCKER_IMAGE}:${IMG_TAG} -f frontend/Dockerfile frontend
              docker push ${DOCKER_IMAGE}:${IMG_TAG}
              docker logout
            '''
          }
        }
      }
    }

    stage('Update GitOps (Kustomize)') {
      steps {
        script {
          withCredentials([usernamePassword(credentialsId: "${GITOPS_CREDENTIALS_ID}",
                                            usernameVariable: 'GIT_USER',
                                            passwordVariable: 'GIT_TOKEN')]) {
            sh '''
              set -e
              rm -rf k8s-config
              git config --global url."https://${GIT_USER}:${GIT_TOKEN}@github.com/".insteadOf "https://github.com/"
              git clone -b ${GITOPS_BRANCH} ${GITOPS_REPO} k8s-config
              cd k8s-config/base/frontend

              echo "üìã Current kustomization.yaml:"
              cat kustomization.yaml

              # ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ kustomize edit set image
              if command -v kustomize >/dev/null 2>&1; then
                echo "‚úÖ Using kustomize CLI"
                kustomize edit set image ${DOCKER_IMAGE}=${DOCKER_IMAGE}:${IMG_TAG}
              elif command -v yq >/dev/null 2>&1; then
                echo "‚úÖ Using yq"
                yq eval -i "(.images[] | select(.name == \\"${DOCKER_IMAGE}\\") | .newTag) = \\"${IMG_TAG}\\"" kustomization.yaml
              else
                echo "‚úÖ Using sed (fallback)"
                # ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç sed pattern ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
                sed -i "/name: ${DOCKER_IMAGE}/!b; n; s/newTag:.*/newTag: ${IMG_TAG}/" kustomization.yaml
              fi

              echo "üìã Updated kustomization.yaml:"
              cat kustomization.yaml

              # ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
              if git diff --quiet; then
                echo "‚ö†Ô∏è  No changes detected in kustomization.yaml"
                exit 0
              fi

              git config user.email "jenkins@local"
              git config user.name "Jenkins CI"
              git add kustomization.yaml
              git commit -m "CI: bump frontend ${DOCKER_IMAGE}:${IMG_TAG}"
              git push origin ${GITOPS_BRANCH}
              
              echo "‚úÖ Successfully updated and pushed to GitOps repo"
            '''
          }
        }
      }
    }

    stage('Trigger ArgoCD Sync') {
      steps {
        script {
          sh '''
            echo "Triggering ArgoCD sync..."
            argocd app sync ${ARGOCD_APP} --grpc-web --insecure || true
          '''
        }
      }
    }
  }

  post {
    success {
      echo "‚úÖ Frontend pipeline completed successfully."
    }
    failure {
      echo "‚ùå Pipeline failed ‚Äì check logs."
    }
  }
}